<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spieldetails - Mowl</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230a0a1a'/><path d='M20 80V20 H35 L50 45 L65 20 H80 V80 H65 V40 L50 65 L35 40 V80 Z' fill='%234ade80'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-green: 0 0 5px rgba(74, 222, 128, 0.8), 0 0 10px rgba(74, 222, 128, 0.6), 0 0 20px rgba(74, 222, 128, 0.4), 0 0 40px rgba(74, 222, 128, 0.2);
        }
        body {
            background-color: #0a0a1a;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            background-image:
                radial-gradient(circle at 1% 1%, #1a1a3a 1px, transparent 2px),
                radial-gradient(circle at 99% 99%, #1a1a3a 1px, transparent 2px);
            background-size: 30px 30px;
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .text-glow-green { text-shadow: var(--glow-green); }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #4ade80;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .gallery-item {
            cursor: pointer;
        }
        #lightbox-modal {
            transition: opacity 0.3s ease;
        }
        #lightbox-image {
             box-shadow: 0 0 25px rgba(74, 222, 128, 0.5);
        }
        .aspect-video {
            aspect-ratio: 16 / 9;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-black/30 backdrop-blur-lg">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold font-orbitron text-glow-green cursor-pointer">MOWL</a>
            <a href="index.html#games" class="text-lg hover:text-green-400">&larr; Zurück zur Übersicht</a>
        </div>
    </header>

    <main id="content-container" class="container mx-auto px-6 pt-32 pb-20 text-center">
        <div id="loader" class="flex justify-center items-center h-64">
            <div class="loader"></div>
        </div>
        <!-- Content will be injected here -->
    </main>
    
    <!-- Lightbox Modal -->
    <div id="lightbox-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[100]">
        <button id="lightbox-close" class="absolute top-6 right-8 text-white text-5xl font-bold hover:text-gray-400 transition-colors">&times;</button>
        <button id="lightbox-prev" class="absolute left-4 md:left-8 text-white text-5xl font-bold hover:text-gray-400 transition-colors">&#8249;</button>
        <img id="lightbox-image" src="" class="max-w-[90vw] max-h-[85vh] rounded-lg border-2 border-green-500/50">
        <button id="lightbox-next" class="absolute right-4 md:right-8 text-white text-5xl font-bold hover:text-gray-400 transition-colors">&#8250;</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      
        const firebaseConfig = {
            apiKey: "AIzaSyB8nVhql9M0IkbyQbmF7AVGvk4mKMObg0A",
            authDomain: "mowl-website.firebaseapp.com",
            projectId: "mowl-website",
            storageBucket: "mowl-website.appspot.com",
            messagingSenderId: "181578753317",
            appId: "1:181578753317:web:f44567dd561d8e7a37a6cc",
            measurementId: "G-9F6YC5NLCS"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const contentContainer = document.getElementById('content-container');
        const loader = document.getElementById('loader');

        const platformIcons = {
            steam: `<svg class="w-full h-full text-white" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Steam</title><path d="M11.996 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 11.996-12A12 12 0 0 0 11.996 0zm0 2.4a9.6 9.6 0 0 1 9.6 9.6 9.6 9.6 0 0 1-9.6 9.6A9.6 9.6 0 0 1 2.4 12a9.6 9.6 0 0 1 9.596-9.6zM6.335 10.05l.012.012c.31.28.575.542.8.766l2.35 2.131c.108.096.228.169.348.216l.012.012c.084.036.18.06.276.06a.516.516 0 0 0 .432-.228l2.94-3.792a.72.72 0 0 0 .108-.3l.012-.024a.493.493 0 0 0-.252-.636l-.024-.012a.493.493 0 0 0-.636.252l-2.436 3.145-2.004-1.813a.42.42 0 0 0-.288-.108.408.408 0 0 0-.444.48zm5.592-3.156a3.12 3.12 0 0 0-3.12 3.12 3.12 3.12 0 0 0 3.12 3.12 3.12 3.12 0 0 0 3.12-3.12 3.12 3.12 0 0 0-3.12-3.12zm0 1.2a1.92 1.92 0 0 1 1.92 1.92 1.92 1.92 0 0 1-1.92 1.92 1.92 1.92 0 0 1-1.92-1.92 1.92 1.92 0 0 1 1.92-1.92z"/></svg>`,
            epic: `<svg class="w-full h-full text-white" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Epic Games</title><path d="M18.571 0H3.428C1.515 0 0 1.716 0 3.818v16.364C0 22.284 1.514 24 3.428 24h15.143C20.485 24 22 22.284 22 20.182V3.818C22 1.716 20.486 0 18.571 0zM15.428 18h-2.142v-4.286h2.142V18zm-4.285 0H9v-1.428h2.143V18zm0-4.286H9v-1.428h2.143v1.428zm0-2.857H9V9.43h2.143v1.428zm4.285 1.428h-2.142v-1.428h2.142v1.428zm0-2.857h-2.142V9.43h2.142v1.428zm0-2.857h-2.142V6h2.142v1.429z"/></svg>`,
            other: `<svg class="w-full h-full text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.916 17.916 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>`
        };
        
        async function loadGameDetails() {
            const params = new URLSearchParams(window.location.search);
            const gameId = params.get('id');

            if (!gameId) {
                contentContainer.innerHTML = '<p class="text-red-500">Keine Spiel-ID gefunden.</p>';
                return;
            }

            const docRef = doc(db, "upcoming-games", gameId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                contentContainer.innerHTML = '<p class="text-red-500">Spiel nicht in der Datenbank gefunden.</p>';
                return;
            }

            const gameData = docSnap.data();
            
            const imageCollectionRef = collection(db, "upcoming-games", gameId, "memoryImages");
            const imageQuery = query(imageCollectionRef, orderBy("createdAt", "asc"));
            const imageSnapshot = await getDocs(imageQuery);
            gameData.memoryImages = imageSnapshot.docs.map(d => d.data().imageData);

            document.title = `${gameData.title || 'Spieldetails'} - Mowl`;
            renderPage(gameData);
        }

        function getMedalClipId(url) {
            try {
                const regex = /medal\.tv\/(?:[a-z]{2}\/)?(?:games\/[^\/]+\/)?clips\/([^\/\?]+)/;
                const match = url.match(regex);
                return match ? match[1] : null;
            } catch (e) { return null; }
        }

        function renderPage(gameData) {
            let galleryHtml = '', clipsHtml = '', commentHtml = '';
            const images = gameData.memoryImages || [];
            const clips = gameData.medalClips || [];

            if (images.length > 0) {
                images.forEach((imageData, index) => {
                    galleryHtml += `
                        <div class="gallery-item overflow-hidden rounded-lg" data-index="${index}">
                            <img src="${imageData}" alt="Erinnerung für ${gameData.title}" class="w-full h-full object-cover transform hover:scale-110 transition-transform duration-300">
                        </div>
                    `;
                });
            } else {
                galleryHtml = '<p class="text-gray-500 md:col-span-2 lg:col-span-3 text-center">Für dieses Spiel wurden noch keine Erinnerungen hochgeladen.</p>';
            }
            
            if (clips.length > 0) {
                 clips.forEach(clip => {
                    const clipId = getMedalClipId(clip.url);
                    if (clipId) {
                        clipsHtml += `
                            <div class="text-left">
                                <h3 class="font-orbitron text-lg mb-2 text-green-300">${clip.name}</h3>
                                <div class="aspect-video rounded-lg overflow-hidden border border-green-500/20">
                                    <iframe src="https://medal.tv/clip/${clipId}/iframe" width="100%" height="100%" frameborder="0" allow="autoplay" allowfullscreen></iframe>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            if (gameData.comment && gameData.comment.trim() !== '') {
                 commentHtml = `
                    <div class="border-t border-green-500/20 pt-12 mt-12">
                        <h2 class="text-4xl font-orbitron font-bold mb-8">Unser Fazit</h2>
                        <p class="text-lg text-gray-300 max-w-3xl mx-auto whitespace-pre-wrap text-left">${gameData.comment}</p>
                    </div>
                `;
            }

            const platformIcon = platformIcons[gameData.platform] || platformIcons.other;

            const pageHtml = `
                <div class="max-w-5xl mx-auto">
                    <div class="relative">
                         <img src="${gameData.image || 'https://placehold.co/1200x600/0a0a1a/ffffff?text=Bild+fehlt'}" alt="${gameData.title}" class="w-full h-64 md:h-96 object-cover rounded-lg mb-8 border-2 border-green-500/30">
                         <div class="absolute bottom-4 left-4 bg-black/80 p-2 rounded-full w-10 h-10">${platformIcon}</div>
                    </div>
                    <h1 class="text-5xl font-orbitron font-bold mb-4 text-glow-green">${gameData.title || 'Unbekanntes Spiel'}</h1>
                    <p class="text-lg text-gray-400 max-w-3xl mx-auto mb-12">${gameData.description || 'Keine Beschreibung verfügbar.'}</p>
                    
                    ${commentHtml}

                    <div class="border-t border-green-500/20 pt-12 mt-12">
                        <h2 class="text-4xl font-orbitron font-bold mb-8">Clips & Highlights</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${clipsHtml || '<p class="text-gray-500 md:col-span-2 text-center">Für dieses Spiel wurden noch keine Clips hinzugefügt.</p>'}</div>
                    </div>

                    <div class="border-t border-green-500/20 pt-12 mt-12">
                        <h2 class="text-4xl font-orbitron font-bold mb-8">Erinnerungen</h2>
                        <div id="memory-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${galleryHtml}</div>
                    </div>
                </div>
            `;
            loader.style.display = 'none';
            contentContainer.innerHTML = pageHtml;
            
            setupLightbox(images);
        }
        
        function setupLightbox(images) {
            if (images.length === 0) return;

            const lightboxModal = document.getElementById('lightbox-modal');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxClose = document.getElementById('lightbox-close');
            const lightboxPrev = document.getElementById('lightbox-prev');
            const lightboxNext = document.getElementById('lightbox-next');
            const gallery = document.getElementById('memory-gallery');
            let currentIndex = 0;

            function showImage(index) {
                if (index < 0 || index >= images.length) return;
                currentIndex = index;
                lightboxImage.src = images[currentIndex];
                lightboxPrev.style.display = index === 0 ? 'none' : 'block';
                lightboxNext.style.display = index === images.length - 1 ? 'none' : 'block';
            }

            function openLightbox(index) {
                lightboxModal.classList.remove('hidden');
                lightboxModal.classList.add('flex');
                showImage(index);
            }

            function closeLightbox() {
                lightboxModal.classList.add('hidden');
                lightboxModal.classList.remove('flex');
            }
            
            gallery.addEventListener('click', (e) => {
                const item = e.target.closest('.gallery-item');
                if (item) {
                    openLightbox(parseInt(item.dataset.index));
                }
            });

            lightboxClose.addEventListener('click', closeLightbox);
            lightboxPrev.addEventListener('click', () => showImage(currentIndex - 1));
            lightboxNext.addEventListener('click', () => showImage(currentIndex + 1));
            
            document.addEventListener('keydown', (e) => {
                if (lightboxModal.classList.contains('hidden')) return;
                if (e.key === 'ArrowRight') lightboxNext.click();
                if (e.key === 'ArrowLeft') lightboxPrev.click();
                if (e.key === 'Escape') closeLightbox();
            });
        }

        document.addEventListener('DOMContentLoaded', loadGameDetails);
    </script>
</body>
</html>

